{% extends 'tom_common/base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Forced Photometry Tool</h2>

  <form id="photometry-form" method="POST" class="mb-4">
    {% csrf_token %}
    <div class="form-row">
      <div class="form-group col-md-3">
        <label for="ra">RA (deg)</label>
        <input type="text" class="form-control" id="ra" name="ra" required>
      </div>
      <div class="form-group col-md-3">
        <label for="dec">DEC (deg)</label>
        <input type="text" class="form-control" id="dec" name="dec" required>
      </div>
      <div class="form-group col-md-3">
        <label for="max_results">Max Results</label>
        <input type="number" class="form-control" id="max_results" name="max_results" min="1" value="10">
      </div>
      <div class="form-group col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Fetch</button>
      </div>
    </div>

    <div class="form-row mt-3">
      <div class="form-group col-md-3">
        <label for="fieldid">Field ID</label>
        <input type="text" class="form-control" id="fieldid" name="fieldid" min="0">
      </div>
      <div class="form-group col-md-3">
        <label for="cropid">Crop ID</label>
        <input type="number" class="form-control" id="cropid" name="cropid" min="0">
      </div>
      <div class="form-group col-md-3">
        <label for="mountnum">Mount</label>
        <input type="number" class="form-control" id="mountnum" name="mountnum" min="0">
      </div>
      <div class="form-group col-md-3">
        <label for="camnum">Camera</label>
        <input type="number" class="form-control" id="camnum" name="camnum" min="0">
      </div>
    </div>

    <div class="form-row mt-3">
      <div class="form-group col-md-3">
        <label for="days">Days Ago</label>
        <input type="number" class="form-control" id="days" name="days" min="0">
      </div>
      <div class="form-group col-md-3" style="text-align: center;">
        <label for="start_date" style="text-align: center">OR</label>
        <small class="form-text text-muted" style="white-space: pre-line">If dates are chosen, 
          "Days Ago" is ignored.
        </small>
      </div>
      <div class="form-group col-md-3">
        <label for="start_date">Start Date</label>
        <input type="date" class="form-control" id="start_date" name="start_date">
      </div>
  
      <div class="form-group col-md-3">
        <label for="end_date">End Date</label>
        <input type="date" class="form-control" id="end_date" name="end_date">
      </div>
    </div>

    <div class="form-row mt-3">
      <div class="form-group col-md-3">
        <label for="use_existing_ref" class="d-flex align-items-center">
          Use Existing Reference &nbsp   
          <span class="text-muted ms-2" style="cursor: help;" data-toggle="tooltip" title="Default is True. When set to False, the Forced Photometry service creates a reference image on the run using all historical visits.">ⓘ</span>
        </label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="use_existing_ref" name="use_existing_ref" checked>
        </div>
      </div>

      <div class="form-group col-md-3">
        <label for="resub" class="d-flex align-items-center">
          Resub &nbsp   
          <span class="text-muted ms-2" style="cursor: help;" data-toggle="tooltip" title="Use this when Use Existing Ref is False.">ⓘ</span>
        </label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="resub" name="resub">
        </div>
      </div>

      <div class="form-group col-md-3">
        <label for="timeout">Timeout (seconds)</label>
        <input type="number" class="form-control" id="timeout" name="timeout" value="30">
      </div>

    </div>

  </form>




  <!-- Placeholder for status message -->
  <div id="status-message"></div>
  
  <!-- Placeholder for error message -->
  {% if error %}
    <div class="alert alert-danger" id="error-message">{{ error }}</div>
  {% endif %}
  
  <!-- Plot Output -->
  <div id="plot-container" class="mt-4">
    {{ plot_div|safe }}
  </div>
</div>
<script>
  const form = document.querySelector('#photometry-form');
  const statusDiv = document.querySelector('#status-message');
  const errorDiv = document.querySelector('#error-message');
  const plotContainer = document.querySelector('#plot-container');

  form.addEventListener('submit', function () {
    statusDiv.innerHTML = `
      <div class="alert alert-info d-flex align-items-center gap-2">
        <div class="spinner-border spinner-border-sm text-primary me-2" role="status" aria-hidden="true"></div>
        <strong> &nbsp Fetching LAST data...</strong>
      </div>`;
    plotContainer.innerHTML = '';
    if (errorDiv) {
      errorDiv.classList.remove('alert', 'alert-danger');
      errorDiv.innerHTML = '';
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (el) {
      new bootstrap.Tooltip(el);
    });
  });
</script>
{% endblock %}